##### 0) SAFETY FIRST ‚Äî create a branch & snapshot
git add -A
git commit -m "pre-seo snapshot" || echo "Nothing new to snapshot."
git checkout -B seo_perf_pass

echo "üîí Protection rules active: DO NOT change any files that match these patterns:"
cat > .seo-protect.txt <<'PROTECT'
src/**/JDR*
src/**/Packages*
src/**/Package*
src/**/HomePackages*
src/**/House*Land*
src/**/AvailableLots*
src/**/Lots*
src/**/Lot*
src/**/Listings*
src/**/Listing*
src/data/**/*
server/data/**/*
public/**/packages/**
public/**/lots/**
public/**/jdr/**
public/**/listings/**
public/**/homes/**
public/**/floorplans/**
PROTECT
sed -n '1,200p' .seo-protect.txt

##### 1) INSTALL MINIMAL DEPENDENCIES (safe, no code changes yet)
npm i compression helmet --save

##### 2) UPDATE index.html <head> ONLY (create a temp marker to control scope)
# We will only edit index.html; everything else is forbidden by our verify step
cat > .tmp_head_replacement.html <<'HEADHTML'
  <!-- BEGIN DOVECOTE SEO HEAD -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <title>Premium Coastal Land & House Packages | Dovecote Estate, Stanley Tasmania</title>
  <meta name="description" content="Discover Dovecote Estate, Stanley‚Äôs premier coastal subdivision with ocean views, heritage charm and future growth potential. Land lots from $254K and designer home packages from $645K." />
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <meta name="author" content="Dovecote Estate" />
  <meta name="language" content="en-AU" />
  <meta name="theme-color" content="#173A22" />
  <link rel="canonical" href="https://dovecoteestate.com.au/" />

  <meta property="og:title" content="Premium Coastal Land & House Packages | Dovecote Estate, Stanley Tasmania" />
  <meta property="og:description" content="Premium residential land and house packages in Stanley, Tasmania. Ocean views, walk to beaches, The Nut and the marina." />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="en_AU" />
  <meta property="og:site_name" content="Dovecote Estate" />
  <meta property="og:url" content="https://dovecoteestate.com.au/" />
  <meta property="og:image" content="https://dovecoteestate.com.au/assets/og/dovecote-og-1200x630.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Premium Coastal Land & House Packages | Dovecote Estate, Stanley Tasmania" />
  <meta name="twitter:description" content="Premium residential land and house packages in Stanley, Tasmania. Ocean views, walk to beaches, The Nut and the marina." />
  <meta name="twitter:image" content="https://dovecoteestate.com.au/assets/og/dovecote-og-1200x630.jpg" />

  <link rel="icon" href="/assets/favicon-de-light.png" media="(prefers-color-scheme: light)" />
  <link rel="icon" href="/assets/favicon-de-dark.png" media="(prefers-color-scheme: dark)" />
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Prata&display=swap" rel="stylesheet" />

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":["RealEstateAgent","LocalBusiness"],"name":"Dovecote Estate","url":"https://dovecoteestate.com.au/","description":"Premium coastal residential subdivision in Stanley, Tasmania offering residential land lots and house & land packages.","logo":"https://dovecoteestate.com.au/assets/dovecote_estate_logo_TIGHT.png","image":"https://dovecoteestate.com.au/assets/og/dovecote-og-1200x630.jpg","address":{"@type":"PostalAddress","addressLocality":"Stanley","addressRegion":"TAS","postalCode":"7331","addressCountry":"AU"},"areaServed":["Stanley","Circular Head"],"sameAs":["https://www.instagram.com/dovecoteestate"],"priceRange":"$254,000 - $785,000"}
  </script>

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebSite","name":"Dovecote Estate","url":"https://dovecoteestate.com.au/","inLanguage":"en-AU","potentialAction":{"@type":"SearchAction","target":"https://dovecoteestate.com.au/?q={search_term_string}","query-input":"required name=search_term_string"}}
  </script>

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[
    {"@type":"Question","name":"Where is Dovecote Estate located?","acceptedAnswer":{"@type":"Answer","text":"A coastal subdivision in Stanley, Tasmania, walking distance to beaches, The Nut and the marina."}},
    {"@type":"Question","name":"What is available at Dovecote Estate?","acceptedAnswer":{"@type":"Answer","text":"Serviced residential land lots and curated house & land packages. Lots from $254,000."}},
    {"@type":"Question","name":"What amenities are nearby?","acceptedAnswer":{"@type":"Answer","text":"Beaches, The Nut, marina, golf club, cafes and regional attractions."}}
  ]}
  </script>

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Product","name":"Premium Residential Land Lots ‚Äî Dovecote Estate","category":"RealEstate","brand":{"@type":"Brand","name":"Dovecote Estate"},"description":"Elevated coastal residential land lots in Stanley, Tasmania. Fully serviced with power, water and NBN.","offers":{"@type":"AggregateOffer","lowPrice":"254000","highPrice":"310400","priceCurrency":"AUD","availability":"https://schema.org/InStock"}}
  </script>

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[
    {"@type":"ListItem","position":1,"name":"Home","item":"https://dovecoteestate.com.au/"},
    {"@type":"ListItem","position":2,"name":"Available Lots","item":"https://dovecoteestate.com.au/#lots"},
    {"@type":"ListItem","position":3,"name":"Gallery","item":"https://dovecoteestate.com.au/gallery"}
  ]}
  </script>

  <link rel="preload" as="image" href="/assets/Photo_6553672_DJI_72_jpg_5716447_0_20201220144554_photo_original_1751955954945.JPG" />
  <!-- END DOVECOTE SEO HEAD -->
HEADHTML

# programmatically replace the entire head in index.html with the block above
node - <<'NODE'
const fs=require('fs');
const html=fs.readFileSync('index.html','utf8');
const newHead=fs.readFileSync('.tmp_head_replacement.html','utf8');
const out=html.replace(/<head[\s\S]*?<\/head>/i, `<head>\n${newHead}\n</head>`);
fs.writeFileSync('index.html', out, 'utf8');
console.log('‚úÖ index.html <head> updated');
NODE
rm -f .tmp_head_replacement.html

##### 3) SERVER: add compression, security, caching, canonical redirects (non-destructive)
# We only append middleware; no route logic or data touched.
node - <<'NODE'
const fs=require('fs');
const path='server/index.ts';
if (!fs.existsSync(path)) {
  console.log('‚ÑπÔ∏è server/index.ts not found; skipping server middleware.');
  process.exit(0);
}
let src=fs.readFileSync(path,'utf8');
if (!/compression\(\)/.test(src)) {
  src = src.replace(/const app = .*?;/s, m => `${m}
import compression from "compression";
import helmet from "helmet";
app.use(helmet({ referrerPolicy: { policy: "no-referrer-when-downgrade" }, contentSecurityPolicy: false }));
app.use(compression());
app.use((req, res, next) => {
  if (/\.(js|css|png|jpe?g|webp|svg|woff2|ico)$/i.test(req.path)) {
    res.setHeader("Cache-Control","public, max-age=2592000, immutable");
  } else if (req.path.endsWith(".html")) {
    res.setHeader("Cache-Control","no-cache");
  }
  next();
});
app.use((req, res, next) => {
  const host = req.headers.host || "";
  const isProd = process.env.NODE_ENV === "production";
  const canonicalHost = "dovecoteestate.com.au";
  const isHttps = (req.headers["x-forwarded-proto"] || req.protocol) === "https";
  if (isProd && (host !== canonicalHost || !isHttps)) return res.redirect(301, \`https://\${canonicalHost}\${req.originalUrl}\`);
  next();
});`);
  fs.writeFileSync(path, src, 'utf8');
  console.log('‚úÖ server middleware added (compression, helmet, cache, canonical)');
} else {
  console.log('‚ÑπÔ∏è server middleware already present');
}
NODE

##### 4) FOOTER CLEANUP ‚Äî replace long block with concise SEO-friendly copy
# We try to find a Footer component and replace only the descriptive paragraph,
# leaving links, contact, and structure intact.
node - <<'NODE'
const fs=require('fs'), globs=['src/**/Footer.*','src/**/footer.*','src/components/**/Footer.*','src/app/**/Footer.*'];
const glob=require('glob');
const files=globs.map(g=>glob.sync(g)).flat().filter(Boolean);
if (files.length===0) { console.log('‚ÑπÔ∏è Footer component not found; skipping.'); process.exit(0); }
const pattern=/(<section[^>]*aria-label=["']About Dovecote Estate["'][\s\S]*?<\/section>)/i;
const replacement=`<section aria-label="About Dovecote Estate" class="mt-8 text-neutral-200/80 max-w-3xl">
  <p>
    Dovecote Estate is a premium coastal residential subdivision in Stanley, Tasmania.
    Serviced residential land and curated house &amp; land packages from $254,000, within walking distance of beaches, The Nut, the marina and the golf club.
  </p>
</section>`;
for (const f of files) {
  let s=fs.readFileSync(f,'utf8');
  if (pattern.test(s)) {
    s=s.replace(pattern, replacement);
    fs.writeFileSync(f,s,'utf8');
    console.log('‚úÖ Footer description updated in', f);
  } else if (/<\/footer>/.test(s)) {
    s=s.replace(/<\/footer>/, `${replacement}\n</footer>`);
    fs.writeFileSync(f,s,'utf8');
    console.log('‚úÖ Footer description inserted in', f);
  }
}
NODE

##### 5) OG IMAGE SLOT ‚Äî ensure path exists (no image content changed)
mkdir -p public/assets/og
# (If you already have an OG image there, nothing else to do.)

##### 6) VERIFY NOTHING PROTECTED CHANGED
echo "üîé Verifying protected files were NOT touched..."
git add -A
CHANGED=$(git diff --name-only --cached)
echo "$CHANGED" > .changed.txt
echo "Changed files:"
cat .changed.txt

# Fail if any protected path appears in the changes
if grep -E -i -q -f .seo-protect.txt .changed.txt; then
  echo "‚ùå Aborting: a protected file appears in the change list. No commit made."
  exit 1
fi

##### 7) COMMIT ONLY THE SAFE CHANGES
git commit -m "SEO/Perf pass: head, server middleware, footer copy, OG slot (JDR & Lots untouched)" || echo "No changes to commit."
git status

echo "‚úÖ Safe SEO/Perf upgrade complete on branch 'seo_perf_pass'."
echo "‚û°Ô∏è Review with: git diff main...seo_perf_pass"
echo "‚û°Ô∏è If happy, merge with: git checkout main && git merge seo_perf_pass && git push"
